<div class="container">

  <!-- HEADER DEL D√çA + ENERG√çA -->
  <header class="header-dia">
    <h1>{{ rutinaGenerada ? rutina.dia : 'Muscle RPG - Rutinas' }}</h1>

    <div class="energia" *ngIf="rutinaGenerada">
      Energ√≠a: <strong>{{ energiaRestante() }} / {{ rutina.energiaMax }}</strong>
    </div>

    <div class="usuario-info">
      <p>Usuario: <strong>{{ userName }}</strong></p>
      <p>Nivel: <strong>{{ userLevel }}</strong></p>
    </div>
  </header>

  <!-- ERROR MESSAGE -->
  <div class="error-message" *ngIf="errorMessage" style="background: #ff4444; color: white; padding: 1rem; margin: 1rem; border-radius: 8px;">
    ‚ö†Ô∏è {{ errorMessage }}
  </div>

  <!-- SELECTOR DE D√çAS (cuando hay rutina semanal) -->
  <div class="selector-dias" *ngIf="rutinaGenerada && rutinaSemanal.length > 0" style="margin: 1.5rem auto; max-width: 800px;">
    <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap; padding: 0 1rem;">
      <button 
        *ngFor="let r of rutinaSemanal; let i = index"
        (click)="cambiarDia(i)"
        [class.activo]="i === diaActual"
        class="btn-dia"
        [style.background]="i === diaActual ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'transparent'"
        [style.color]="i === diaActual ? 'white' : '#667eea'"
        [style.border-color]="i === diaActual ? 'transparent' : '#667eea'">
        {{ diasSemana[i] }}
        <span style="font-size: 0.75rem; display: block; margin-top: 0.25rem;">
          {{ r.ejercicios.length > 0 ? 'üí™ ' + r.ejercicios.length + ' ej.' : 'üò¥ Descanso' }}
        </span>
      </button>
    </div>
  </div>

  <!-- BOT√ìN GENERAR RUTINA (cuando no hay rutina generada) -->
  <div class="generar-rutina" *ngIf="!rutinaGenerada && !loading">
    <div class="card-generar">
      <h2>üìÖ Rutina Semanal</h2>
      <p>Genera tu rutina de entrenamiento personalizada optimizada por algoritmo de grafos DAG</p>
      
      <div class="info-stats" *ngIf="user">
        <div class="stat-item">
          <span class="stat-label">Stamina disponible:</span>
          <span class="stat-value">{{ user.staminaActual || 100 }} / {{ user.staminaMaxima || 100 }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Nivel:</span>
          <span class="stat-value">{{ user.nivel || 1 }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Tiempo disponible:</span>
          <span class="stat-value">120 minutos</span>
        </div>
      </div>

      <button class="btn-generar-rutina" (click)="generarRutinaDiaria()">
        üöÄ GENERAR RUTINA
      </button>

      <div class="hint">
        <small>El sistema calcular√° la rutina √≥ptima basada en tu perfil, nivel y estado actual</small>
      </div>
    </div>
  </div>

  <!-- LOADING STATE -->
  <div class="loading" *ngIf="loading" style="text-align: center; padding: 3rem;">
    <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
    <p style="margin-top: 1rem; color: #666;">Generando tu rutina √≥ptima... ü§ñ</p>
  </div>

  <!-- ESTADO INICIAL (cuando la rutina est√° generada pero no iniciada) -->
  <div class="estado-inicial" *ngIf="rutinaGenerada && !sesionActiva && !sesionFinalizada">
    <div class="card-inicial">

      <h2>‚úÖ Rutina generada exitosamente</h2>
      <p *ngIf="rutina.descripcion">{{ rutina.descripcion }}</p>
      
      <div class="muscle-groups" *ngIf="rutina.muscleGroups && rutina.muscleGroups.length > 0" 
           style="background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
        <strong style="color: #667eea;">üéØ Grupos musculares:</strong>
        <span style="margin-left: 0.5rem; font-size: 1.1rem;">{{ rutina.muscleGroups.join(' + ') }}</span>
      </div>

      <div class="stats-rutina" *ngIf="rutina.xpTotalEstimado">
        <div class="stat">
          <span class="label">XP Estimado:</span>
          <span class="value">{{ rutina.xpTotalEstimado | number:'1.0-0' }}</span>
        </div>
        <div class="stat">
          <span class="label">Ejercicios:</span>
          <span class="value">{{ rutina.ejercicios.length }}</span>
        </div>
        <div class="stat">
          <span class="label">Tiempo:</span>
          <span class="value">{{ rutina.tiempoTotal || rutina.tiempoPlaneado }} min</span>
        </div>
      </div>

      <div class="info-energia">
        <strong>Energ√≠a disponible:</strong>
        <span class="valor-energia" [class.baja]="energiaRestante() < 30">
          {{ energiaRestante() }} / {{ rutina.energiaMax }}
        </span>
      </div>

      <button class="btn-comenzar" (click)="comenzarEntrenamiento()">
        üí™ COMENZAR ENTRENAMIENTO
      </button>

      <button class="btn-secondary" (click)="regenerarRutina()" style="margin-top: 1rem;">
        üîÑ Generar Nueva Rutina
      </button>

      <!-- Botones de m√©tricas -->
      <div style="display: flex; gap: 0.5rem; margin-top: 1rem; justify-content: center;">
        <button class="btn-metrics" (click)="toggleMetricas()">
          üìä {{ mostrarMetricas ? 'Ocultar' : 'Ver' }} M√©tricas
        </button>
        <button class="btn-metrics" (click)="toggleCicloTrimestral()">
          üìà {{ mostrarCicloTrimestral ? 'Ocultar' : 'Ver' }} Ciclo Trimestral
        </button>
      </div>
    </div>

    <!-- PANEL DE M√âTRICAS DE OPTIMIZACI√ìN -->
    <div class="metricas-panel" *ngIf="mostrarMetricas" style="margin-top: 1.5rem; padding: 1.5rem; background: #f8f9fa; border-radius: 12px; border: 2px solid #667eea;">
      <h3 style="color: #667eea; margin-bottom: 1rem;">üìä M√©tricas de Optimizaci√≥n</h3>
      
      <div class="metricas-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        <!-- Balance Muscular -->
        <div class="metric-card" style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <div style="font-size: 0.875rem; color: #666; margin-bottom: 0.5rem;">Balance Muscular</div>
          <div style="font-size: 1.5rem; font-weight: bold; color: #667eea;">
            {{ (balanceMuscular * 100) | number:'1.0-0' }}%
          </div>
          <div class="progress-bar" style="margin-top: 0.5rem; height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden;">
            <div style="height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s;" 
                 [style.width.%]="balanceMuscular * 100"></div>
          </div>
        </div>

        <!-- Ratio de Eficiencia -->
        <div class="metric-card" style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <div style="font-size: 0.875rem; color: #666; margin-bottom: 0.5rem;">Ratio XP/(Tiempo+Fatiga)</div>
          <div style="font-size: 1.5rem; font-weight: bold; color: #28a745;">
            {{ ratioEficiencia | number:'1.1-1' }}
          </div>
          <div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem;">Eficiencia promedio</div>
        </div>

        <!-- Volume Landmarks -->
        <div class="metric-card" *ngIf="rutina.volumeLandmarks" style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <div style="font-size: 0.875rem; color: #666; margin-bottom: 0.5rem;">Volumen Semanal</div>
          <div style="display: flex; justify-content: space-between; font-size: 0.875rem; margin-top: 0.5rem;">
            <span title="Minimum Effective Volume">MEV: {{ rutina.volumeLandmarks.MEV }}</span>
            <span title="Maximum Adaptive Volume" style="color: #667eea; font-weight: bold;">MAV: {{ rutina.volumeLandmarks.MAV }}</span>
            <span title="Maximum Recoverable Volume">MRV: {{ rutina.volumeLandmarks.MRV }}</span>
          </div>
        </div>

        <!-- Algoritmo usado -->
        <div class="metric-card" style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <div style="font-size: 0.875rem; color: #666; margin-bottom: 0.5rem;">Algoritmo</div>
          <div style="font-size: 1rem; font-weight: bold; color: #764ba2;">
            Graph Greedy DAG
          </div>
          <div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem;">Optimizaci√≥n v2.0</div>
        </div>
      </div>

      <!-- Distribuci√≥n de grupos musculares -->
      <div class="muscle-distribution" *ngIf="rutina.ejercicios.length > 0" style="margin-top: 1.5rem;">
        <h4 style="color: #667eea; margin-bottom: 0.75rem;">Distribuci√≥n de Grupos Musculares</h4>
        <div style="background: white; padding: 1rem; border-radius: 8px;">
          <div *ngFor="let ej of rutina.ejercicios" style="margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid #eee;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="font-size: 0.875rem;">{{ ej.nombre }}</span>
              <div style="display: flex; gap: 0.5rem; align-items: center;">
                <span style="font-size: 0.75rem; color: #667eea;">
                  {{ ej.targetMuscles && ej.targetMuscles.length > 0 ? ej.targetMuscles[0] : 'general' }}
                </span>
                <span style="font-size: 0.75rem; padding: 0.125rem 0.5rem; background: #667eea22; border-radius: 12px; color: #667eea;">
                  Ratio: {{ ej.estimuloXP && ej.costoTiempo && ej.costoFatiga ? (ej.estimuloXP / (ej.costoTiempo + ej.costoFatiga / 10)) | number:'1.1-1' : 'N/A' }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PANEL DE CICLO TRIMESTRAL -->
    <div class="ciclo-panel" *ngIf="mostrarCicloTrimestral && cicloTrimestral" style="margin-top: 1.5rem; padding: 1.5rem; background: #f8f9fa; border-radius: 12px; border: 2px solid #28a745;">
      <h3 style="color: #28a745; margin-bottom: 1rem;">üìà Planificaci√≥n Trimestral (12 semanas)</h3>
      
      <div class="ciclo-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
        <div class="stat-box" style="background: white; padding: 1rem; border-radius: 8px; text-align: center;">
          <div style="font-size: 0.75rem; color: #666;">XP Total Proyectado</div>
          <div style="font-size: 1.5rem; font-weight: bold; color: #28a745;">
            {{ cicloTrimestral.totalXPGained | number:'1.0-0' }}
          </div>
        </div>
        <div class="stat-box" style="background: white; padding: 1rem; border-radius: 8px; text-align: center;">
          <div style="font-size: 0.75rem; color: #666;">Fatiga Final</div>
          <div style="font-size: 1.5rem; font-weight: bold;" [style.color]="cicloTrimestral.finalFatigue < 0.5 ? '#28a745' : '#ff6b6b'">
            {{ (cicloTrimestral.finalFatigue * 100) | number:'1.0-0' }}%
          </div>
        </div>
        <div class="stat-box" style="background: white; padding: 1rem; border-radius: 8px; text-align: center;">
          <div style="font-size: 0.75rem; color: #666;">Adherencia Promedio</div>
          <div style="font-size: 1.5rem; font-weight: bold; color: #667eea;">
            {{ (cicloTrimestral.averageAdherence * 100) | number:'1.0-0' }}%
          </div>
        </div>
      </div>

      <!-- Progresi√≥n semanal -->
      <div class="weekly-progression" style="background: white; padding: 1rem; border-radius: 8px;">
        <h4 style="color: #28a745; margin-bottom: 1rem;">Progresi√≥n Semanal</h4>
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
            <thead>
              <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                <th style="padding: 0.5rem; text-align: left;">Semana</th>
                <th style="padding: 0.5rem; text-align: center;">Volumen</th>
                <th style="padding: 0.5rem; text-align: center;">Fatiga</th>
                <th style="padding: 0.5rem; text-align: center;">Acci√≥n</th>
                <th style="padding: 0.5rem; text-align: right;">XP Ganada</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let decision of cicloTrimestral.weeklyDecisions" 
                  style="border-bottom: 1px solid #dee2e6;"
                  [style.background]="decision.accion.tipo === 'deload' ? '#fff3cd' : 'white'">
                <td style="padding: 0.5rem;">Semana {{ decision.semana }}</td>
                <td style="padding: 0.5rem; text-align: center; font-weight: bold;">{{ decision.estado.volumen }}</td>
                <td style="padding: 0.5rem; text-align: center;">
                  <span [style.color]="decision.estado.fatiga < 0.5 ? '#28a745' : decision.estado.fatiga < 0.7 ? '#ffc107' : '#dc3545'">
                    {{ (decision.estado.fatiga * 100) | number:'1.0-0' }}%
                  </span>
                </td>
                <td style="padding: 0.5rem; text-align: center;">
                  <span class="badge" 
                        [style.background]="decision.accion.tipo === 'increase' ? '#28a74522' : decision.accion.tipo === 'deload' ? '#dc354522' : '#667eea22'"
                        [style.color]="decision.accion.tipo === 'increase' ? '#28a745' : decision.accion.tipo === 'deload' ? '#dc3545' : '#667eea'"
                        style="padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; text-transform: uppercase;">
                    {{ decision.accion.tipo === 'increase' ? '‚¨ÜÔ∏è Sobrecarga' : decision.accion.tipo === 'deload' ? '‚¨áÔ∏è Descarga' : '‚û°Ô∏è Mantener' }}
                  </span>
                </td>
                <td style="padding: 0.5rem; text-align: right; font-weight: bold; color: #28a745;">
                  +{{ decision.ganancia | number:'1.0-0' }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Gr√°fico visual simple -->
      <div class="volume-chart" style="margin-top: 1.5rem; background: white; padding: 1rem; border-radius: 8px;">
        <h4 style="color: #28a745; margin-bottom: 1rem;">Curva de Volumen</h4>
        <div style="display: flex; align-items: flex-end; gap: 0.25rem; height: 150px; padding: 1rem;">
          <div *ngFor="let vol of cicloTrimestral.volumeProgression; let i = index"
               style="flex: 1; background: linear-gradient(to top, #28a745, #28a74588); border-radius: 4px 4px 0 0; position: relative; cursor: pointer;"
               [style.height.%]="(vol / getMaxVolume(cicloTrimestral.volumeProgression)) * 100"
               [title]="'Semana ' + (i+1) + ': ' + vol + ' series'">
            <div style="position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 0.625rem; color: #666; white-space: nowrap;">
              S{{ i+1 }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading para ciclo trimestral -->
    <div *ngIf="loadingCiclo" style="text-align: center; padding: 2rem; margin-top: 1rem; background: #f8f9fa; border-radius: 12px;">
      <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #28a745; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
      <p style="margin-top: 1rem; color: #666;">Calculando ciclo trimestral √≥ptimo... üßÆ</p>
    </div>
  </div>

  <!-- DURANTE EL ENTRENAMIENTO -->
  <div class="durante" *ngIf="sesionActiva">
    <div class="cronometro">
      Tiempo transcurrido: <strong>{{ tiempoTranscurrido() }}</strong> minutos
    </div>

    <button class="btn-finalizar" (click)="finalizarEntrenamiento()">
      Finalizar entrenamiento
    </button>
  </div>

  <!-- LISTA DE EJERCICIOS -->
  <div class="ejercicios" *ngIf="sesionActiva || sesionFinalizada">
    <div
      *ngFor="let ej of rutina.ejercicios; let i = index"
      class="ejercicio"
      [class.hecho]="ej.hecho"
      (click)="marcarEjercicio(ej)"
      [style.cursor]="sesionFinalizada ? 'default' : 'pointer'"
      [style.opacity]="sesionFinalizada && !ej.hecho ? 0.5 : 1">

      <div class="izq">
        <div class="num">{{ i + 1 }}</div>
      </div>

      <div class="centro">
        <div class="nombre">{{ ej.nombre }}</div>
        <div class="detalle">
          {{ ej.sets }}√ó{{ ej.reps }} rep. ‚Ä¢ RIR {{ ej.rir || 2 }} ‚Ä¢ ‚âà{{ ej.tiempo }} min ‚Ä¢ XP {{ ej.estimuloXP | number:'1.0-0' }}
        </div>
        <div class="muscles" *ngIf="ej.targetMuscles && ej.targetMuscles.length > 0" 
             style="font-size: 0.75rem; color: #667eea; margin-top: 0.25rem;">
          üéØ {{ ej.targetMuscles.join(', ') }}
        </div>
      </div>

      <div class="check" *ngIf="ej.hecho">‚úì</div>
    </div>
  </div>

  <!-- RESUMEN FINAL -->
  <div class="resumen" *ngIf="sesionFinalizada">
    <h3>Entrenamiento completado</h3>

    <p>Tiempo dedicado: <strong>{{ tiempoRealMinutos }} min</strong></p>

    <p>Ejercicios completados:
      <strong>{{ ejerciciosCompletados() }} / {{ rutina.ejercicios.length }}</strong>
    </p>

    <p>Energ√≠a consumida:
      <strong>{{ energiaGastada }}</strong>
    </p>

    <p>Energ√≠a restante:
      <strong>{{ energiaRestante() }}</strong>
    </p>
  </div>

</div>

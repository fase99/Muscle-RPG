<div class="container">

  <!-- HEADER DEL DÃA + ENERGÃA -->
  <header class="header-dia">
    <h1>{{ rutinaGenerada ? rutina.dia : 'Muscle RPG - MisiÃ³n Diaria' }}</h1>

    <div class="energia" *ngIf="rutinaGenerada && !esDescansoProgramado">
      EnergÃ­a: <strong>{{ energiaRestante() }} / {{ rutina.energiaMax }}</strong>
    </div>

    <div class="usuario-info">
      <p>Usuario: <strong>{{ userName }}</strong></p>
      <p>Nivel: <strong>{{ userLevel }}</strong></p>
      <p style="font-size: 0.9rem; color: #888;">ğŸ“… {{ fechaActual | date:'fullDate':'':'es-ES' }}</p>
    </div>
  </header>

  <!-- ERROR MESSAGE -->
  <div class="error-message" *ngIf="errorMessage" style="background: #ff4444; color: white; padding: 1rem; margin: 1rem; border-radius: 8px;">
    âš ï¸ {{ errorMessage }}
  </div>

  <!-- SELECTOR DE DÃAS DESHABILITADO - Solo se muestra la rutina de HOY segÃºn el paper -->
  <!-- SecciÃ³n VII.D: "genera una sesiÃ³n personalizada para cada dÃ­a, diseÃ±ada especÃ­ficamente segÃºn el estado real del usuario en ese momento" -->
  
  <!-- MENSAJE INFORMATIVO: Solo se muestra la misiÃ³n de hoy -->
  <div *ngIf="rutinaGenerada" style="text-align: center; padding: 1rem; background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%); margin: 1rem auto; max-width: 600px; border-radius: 12px; border-left: 4px solid #667eea;">
    <p style="margin: 0; color: #667eea; font-weight: 600;">
      ğŸ¯ MisiÃ³n del DÃ­a - Modelo de OptimizaciÃ³n Diaria
    </p>
    <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: #ffffff;">
      El sistema solo muestra la rutina programada para HOY basada en tu estado actual
    </p>
  </div>

  <!-- VISTA PREVIA DE PRÃ“XIMOS DÃAS -->
  <div *ngIf="rutinaGenerada && proximasRutinas.length > 0" class="proximos-dias-container">
    <h3 style="text-align: center; color: #667eea; margin: 1.5rem 0 1rem 0; font-size: 1.1rem;">
      ğŸ“… PrÃ³ximos entrenamientos
    </h3>
    <div class="proximos-dias-scroll">
      <div *ngFor="let proximaRutina of proximasRutinas" class="proxima-dia-card">
        <div class="proxima-dia-header">
          <span class="proxima-dia-nombre">{{ getDayName(proximaRutina.scheduledDate) }}</span>
          <span class="proxima-dia-fecha">{{ formatShortDate(proximaRutina.scheduledDate) }}</span>
        </div>
        <div class="proxima-dia-body">
          <div class="proxima-dia-tipo" *ngIf="proximaRutina.ejercicios.length > 0">
            <strong>{{ getMuscleGroupName(proximaRutina.nombre) }}</strong>
          </div>
          <div class="proxima-dia-tipo" *ngIf="proximaRutina.ejercicios.length === 0" style="color: #888;">
            â˜€ï¸ Descanso
          </div>
          <div class="proxima-dia-stats" *ngIf="proximaRutina.ejercicios.length > 0">
            <span>ğŸ’ª {{ proximaRutina.ejercicios.length }} ejercicios</span>
            <span>â±ï¸ {{ proximaRutina.tiempoTotal | number:'1.0-0' }} min</span>
          </div>
          <div class="proxima-dia-stats" *ngIf="proximaRutina.ejercicios.length === 0" style="font-size: 0.8rem; color: #999;">
            RecuperaciÃ³n activa
          </div>
        </div>
        <div class="proxima-dia-footer">
          <span style="font-size: 0.75rem; color: #999;">ğŸ”’ Vista previa</span>
        </div>
      </div>
    </div>
  </div>

  <!-- BOTÃ“N GENERAR RUTINA (cuando no hay rutina generada) -->
  <div class="generar-rutina" *ngIf="!rutinaGenerada && !loading">
    <div class="card-generar">
      <h2>ğŸ“… MisiÃ³n Diaria</h2>
      <p>Genera tu rutina de entrenamiento personalizada optimizada por algoritmo de grafos DAG</p>
      <p style="font-size: 0.9rem; color: #888; margin-top: 0.5rem;">
        El sistema calcularÃ¡ la rutina Ã³ptima solo para HOY segÃºn tu estado actual
      </p>
      
      <div class="info-stats" *ngIf="user">
        <div class="stat-item">
          <span class="stat-label">Stamina disponible:</span>
          <span class="stat-value">{{ user.staminaActual || 100 }} / {{ user.staminaMaxima || 100 }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Nivel:</span>
          <span class="stat-value">{{ user.nivel || 1 }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Tiempo disponible:</span>
          <span class="stat-value">120 minutos</span>
        </div>
      </div>

      <button class="btn-generar-rutina" (click)="generarRutinaDiaria()">
        ğŸš€ GENERAR MISIÃ“N DE HOY
      </button>

      <div class="hint">
        <small>El sistema calcularÃ¡ la rutina Ã³ptima basada en tu perfil, nivel y estado actual del dÃ­a</small>
      </div>
    </div>
  </div>

  <!-- LOADING STATE -->
  <div class="loading" *ngIf="loading" style="text-align: center; padding: 3rem;">
    <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
    <p style="margin-top: 1rem; color: #666;">Generando tu rutina Ã³ptima... ğŸ¤–</p>
  </div>

<!-- ESTADO INICIAL: ENTRENAMIENTO O DESCANSO -->
<div class="estado-inicial" *ngIf="rutinaGenerada && !sesionActiva && !sesionFinalizada">
  
  <!-- CASO ESPECIAL: DÃA DE DESCANSO PROGRAMADO -->
  <div *ngIf="esDescansoProgramado" class="card-descanso" style="max-width: 600px; margin: 2rem auto; padding: 3rem; background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%); border-radius: 16px; text-align: center;">
    <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ˜´</div>
    <h2 style="color: #667eea; margin-bottom: 1rem;">DÃ­a de Descanso</h2>
    <p style="font-size: 1.1rem; color: #ffffff; margin-bottom: 2rem;">
      Hoy estÃ¡ programado para recuperaciÃ³n y regeneraciÃ³n de stamina
    </p>
    
    <div style="background: rgb(26, 46, 114); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
      <h3 style="color: #667eea; margin-bottom: 1rem;">ğŸ’¡ Recomendaciones:</h3>
      <ul style="text-align: left; color: #ffffff; list-style-position: inside;">
        <li>RecuperaciÃ³n activa (caminata ligera, yoga)</li>
        <li>HidrataciÃ³n adecuada</li>
        <li>AlimentaciÃ³n balanceada</li>
        <li>SueÃ±o de calidad (7-9 horas)</li>
      </ul>
    </div>
    
    <button class="btn-generar-rutina" (click)="regenerarRutina()" 
            style="background: linear-gradient(135deg, #2849da 0%, #666 100%);">
      ğŸ”„ Volver al Inicio
    </button>
  </div>

  <!-- CASO 1: HAY EJERCICIOS â†’ RUTINA NORMAL DEL DÃA ACTUAL -->
  <div class="card-inicial" *ngIf="!esDescansoProgramado && rutinaDelDia && rutina.ejercicios.length > 0">
    <h2>Rutina Optimizada</h2>
    <p *ngIf="rutina.descripcion">{{ rutina.descripcion }}</p>
    
    <div class="muscle-groups" *ngIf="rutina.muscleGroups && rutina.muscleGroups.length > 0" 
         style="background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
      <strong style="color: #667eea;">ğŸ¯ Grupos musculares:</strong>
      <span style="margin-left: 0.5rem; font-size: 1.1rem;">{{ rutina.muscleGroups.join(' + ') }}</span>
    </div>

    <div class="stats-rutina" *ngIf="rutina.xpTotalEstimado">
      <div class="stat">
        <span class="label">XP Estimado:</span>
        <span class="value">{{ rutina.xpTotalEstimado | number:'1.0-0' }}</span>
      </div>
      <div class="stat">
        <span class="label">Ejercicios:</span>
        <span class="value">{{ rutina.ejercicios.length }}</span>
      </div>
      <div class="stat">
        <span class="label">Tiempo:</span>
        <span class="value">{{ rutina.tiempoTotal || rutina.tiempoPlaneado }} min</span>
      </div>
    </div>

    <div class="info-energia">
      <strong>EnergÃ­a disponible:</strong>
      <span class="valor-energia" [class.baja]="energiaRestante() < 30">
        {{ energiaRestante() }} / {{ rutina.energiaMax }}
      </span>
    </div>

    <!-- Resumen de cargas -->
    <div class="resumen-cargas" *ngIf="rutina.ejercicios && rutina.ejercicios.length > 0">
      <h3 style="font-size: 1rem; color: #60a5fa; margin-bottom: 12px;">ğŸ“Š Resumen de Cargas</h3>
      <div class="cargas-stats">
        <div class="carga-stat">
          <span class="carga-label">Ejercicios con peso:</span>
          <span class="carga-value">{{ contarEjerciciosConPeso() }} / {{ rutina.ejercicios.length }}</span>
        </div>
        <div class="carga-stat" *ngIf="obtenerPesoPromedio() > 0">
          <span class="carga-label">Peso promedio:</span>
          <span class="carga-value peso-destacado">{{ obtenerPesoPromedio() | number:'1.1-1' }}kg</span>
        </div>
        <div class="carga-stat">
          <span class="carga-label">RIR promedio:</span>
          <span class="carga-value">{{ obtenerRIRPromedio() | number:'1.0-0' }}</span>
        </div>
      </div>
    </div>

    <button class="btn-comenzar" (click)="comenzarEntrenamiento()">
      ğŸ’ª COMENZAR MISIÃ“N
    </button>
  </div>
</div>

  <!-- DURANTE EL ENTRENAMIENTO -->
  <div class="durante" *ngIf="sesionActiva">
    <button class="btn-finalizar" (click)="finalizarEntrenamiento()">
      Finalizar entrenamiento
    </button>
  </div>

  <!-- LISTA DE EJERCICIOS -->
  <div class="ejercicios" *ngIf="sesionActiva || sesionFinalizada">
    <div
      *ngFor="let ej of rutina.ejercicios; let i = index"
      class="ejercicio"
      [class.hecho]="ej.hecho"
      (click)="marcarEjercicio(ej, i)"
      [style.cursor]="sesionFinalizada ? 'default' : 'pointer'"
      [style.opacity]="sesionFinalizada && !ej.hecho ? 0.5 : 1">

      <div class="izq">
        <div class="num">{{ i + 1 }}</div>
      </div>

      <div class="centro">
        <div class="nombre">{{ ej.nombre }}</div>
        <div class="detalle">
          {{ ej.sets }}Ã—{{ ej.reps }} rep. â€¢ 
          <span class="peso-destacado" *ngIf="ej.peso && ej.peso > 0">ğŸ’ª {{ ej.peso }}kg</span>
          <span *ngIf="!ej.peso || ej.peso === 0" style="color: #ff6b6b;">âš ï¸ Sin peso asignado</span>
          â€¢ RIR {{ ej.rir || 2 }} â€¢ 
          <span *ngIf="ej.intensidad" class="intensidad-tag">{{ ej.intensidad }}% 1RM</span>
          â‰ˆ{{ ej.tiempo }} min â€¢ XP {{ ej.estimuloXP | number:'1.0-0' }}
        </div>
        <div class="notas-ejercicio" *ngIf="ej.notas" style="font-size: 0.7rem; color: #999; margin-top: 0.25rem; font-style: italic;">
          ğŸ“ {{ ej.notas }}
        </div>
        <div class="muscles" *ngIf="ej.targetMuscles && ej.targetMuscles.length > 0" 
             style="font-size: 0.75rem; color: #667eea; margin-top: 0.25rem;">
          ğŸ¯ {{ ej.targetMuscles.join(', ') }}
        </div>
      </div>

      <div class="check" *ngIf="ej.hecho">âœ“</div>
    </div>
  </div>

  <!-- RESUMEN FINAL -->
  <div class="resumen" *ngIf="sesionFinalizada">
    <h3>Entrenamiento completado</h3>

    <p>Tiempo dedicado: <strong>{{ tiempoRealMinutos }} min</strong></p>

    <p>Ejercicios completados:
      <strong>{{ ejerciciosCompletados() }} / {{ rutina.ejercicios.length }}</strong>
    </p>

    <p>EnergÃ­a consumida:
      <strong>{{ energiaGastada }}</strong>
    </p>

    <p>EnergÃ­a restante:
      <strong>{{ energiaRestante() }}</strong>
    </p>
  </div>

</div>

<div class="ejercicios-container">
  <h1 class="main-title">CAMBIAR</h1>
  <!-- Vista de todos los √°rboles -->
  @if (!selectedExercise()) {
    <div class="all-trees-view">
      <h1 class="main-title">Muscle RPG - {{ userName }}</h1>
      <p class="main-subtitle">Nivel {{ userLevel }} | Progresa en tus entrenamientos desbloqueando nuevos ejercicios</p>
      
      <div class="trees-grid">
        @for (group of muscleGroups(); track group.group) {
          <div class="tree-column">
            <div class="tree-header" [style.border-color]="group.color">
              <span class="tree-icon" [style.color]="group.color">{{ group.icon }}</span>
              <h2 class="tree-title" [style.color]="group.color">{{ group.name }}</h2>
              <div class="tree-stats">
                <span class="stat-item">{{ group.completedExercises }}/{{ group.exercises.length }}</span>
                <span class="stat-divider">‚Ä¢</span>
                <span class="stat-item">{{ group.totalXP }} XP</span>
              </div>
              <div class="progress-bar">
                <div 
                  class="progress-fill"
                  [style.width.%]="(group.completedExercises / group.exercises.length) * 100"
                  [style.background-color]="group.color">
                </div>
              </div>
            </div>

            <div class="skill-tree">
              @for (exercise of group.exercises; track exercise.id; let i = $index) {
                <div class="skill-node-wrapper">
                  @if (i > 0) {
                    <div class="skill-connector" 
                         [class.completed]="group.exercises[i-1].completed"
                         [style.background]="group.exercises[i-1].completed ? 
                           'linear-gradient(to bottom, transparent 0%, rgba(46, 204, 113, 0.5) 20%, rgba(46, 204, 113, 0.8) 50%, rgba(46, 204, 113, 0.5) 80%, transparent 100%)' : 
                           'linear-gradient(to bottom, transparent 0%, ' + hexToRgba(group.color, 0.3) + ' 20%, ' + hexToRgba(group.color, 0.5) + ' 50%, ' + hexToRgba(group.color, 0.3) + ' 80%, transparent 100%)'">
                    </div>
                  }
                  
                  <div 
                    class="skill-node"
                    [class.unlocked]="exercise.unlocked"
                    [class.locked]="!exercise.unlocked"
                    [class.completed]="exercise.completed"
                    [attr.data-group-color]="group.color"
                    (click)="selectExercise(exercise, group)">
                    
                    <div class="skill-level">Nivel {{ exercise.level }}</div>
                    <div class="skill-name">{{ exercise.name }}</div>
                    <div class="skill-xp">+{{ exercise.xpReward }} XP</div>
                    
                    @if (exercise.completed) {
                      <div class="completed-badge">‚úì</div>
                    }
                    @if (!exercise.unlocked) {
                      <div class="locked-overlay">üîí</div>
                    }
                  </div>
                </div>
              }
            </div>
          </div>
        }
      </div>
    </div>
  }

  <!-- Vista de Detalle del Ejercicio -->
  @if (selectedExercise()) {
    <div class="exercise-detail-view">
      <button class="back-button" (click)="backToTree()">‚Üê Volver a los √Årboles</button>
      
      <div class="exercise-detail-card">
        <div class="detail-header" [style.background-color]="selectedGroup()!.color">
          <h1>{{ selectedExercise()!.name }}</h1>
          <span class="level-badge">{{ getExerciseLevel(selectedExercise()!.level) }}</span>
        </div>

        <div class="detail-body">
          <div class="detail-section">
            <h3>üìù Descripci√≥n</h3>
            <p>{{ selectedExercise()!.description }}</p>
          </div>

          <div class="detail-stats">
            <div class="stat-item">
              <span class="stat-icon">üí™</span>
              <div>
                <div class="stat-name">Series</div>
                <div class="stat-number">{{ selectedExercise()!.sets }}</div>
              </div>
            </div>
            <div class="stat-item">
              <span class="stat-icon">üî¢</span>
              <div>
                <div class="stat-name">Repeticiones</div>
                <div class="stat-number">{{ selectedExercise()!.reps }}</div>
              </div>
            </div>
            <div class="stat-item">
              <span class="stat-icon">‚è±Ô∏è</span>
              <div>
                <div class="stat-name">Descanso</div>
                <div class="stat-number">{{ selectedExercise()!.restTime }}s</div>
              </div>
            </div>
            <div class="stat-item">
              <span class="stat-icon">‚≠ê</span>
              <div>
                <div class="stat-name">Recompensa</div>
                <div class="stat-number">{{ selectedExercise()!.xpReward }} XP</div>
              </div>
            </div>
          </div>

          @if (selectedExercise()!.prerequisites && selectedExercise()!.prerequisites!.length > 0) {
            <div class="detail-section">
              <h3>üîì Requisitos Previos</h3>
              <ul class="prerequisites-list">
                @for (prereqId of selectedExercise()!.prerequisites!; track prereqId) {
                  @for (ex of selectedGroup()!.exercises; track ex.id) {
                    @if (ex.id === prereqId) {
                      <li [class.completed]="ex.completed">
                        {{ ex.name }} 
                        @if (ex.completed) {
                          <span class="check">‚úì</span>
                        }
                      </li>
                    }
                  }
                }
              </ul>
            </div>
          }

          @if (!selectedExercise()!.completed) {
            <button 
              class="complete-button"
              [style.background-color]="selectedGroup()!.color"
              (click)="completeExercise(selectedExercise()!)">
              ‚úì Marcar como Completado
            </button>
          } @else {
            <div class="completed-message">
              <span class="trophy">üèÜ</span>
              <p>¬°Ejercicio completado! Has ganado {{ selectedExercise()!.xpReward }} XP</p>
            </div>
          }
        </div>
      </div>
    </div>
  }
</div>
